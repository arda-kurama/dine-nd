name: Daily Menu Update

on:
    # every day at 05:00 UTC
    schedule:
        - cron: "0 5 * * *"
    workflow_dispatch:

jobs:
    scrape_and_publish:
        runs-on: ubuntu-latest
        steps:
            # Check out your repo
            - uses: actions/checkout@v3
              with:
                  ref: main
                  fetch-depth: 0

            # Install Chrome + matching ChromeDriver in one go
            - name: Set up Chrome & ChromeDriver
              uses: browser-actions/setup-chrome@v2
              with:
                  chrome-version: stable
                  install-dependencies: true
                  install-chromedriver: true

            # Symlink Chrome & ChromeDriver to standard locations
            - name: Symlink Chrome & ChromeDriver
              run: |
                  sudo ln -sf "$(which chromedriver)" /usr/bin/chromedriver
                  sudo ln -sf "$(which google-chrome)"   /usr/bin/chrome
                  sudo ln -sf "$(which google-chrome)"   /usr/bin/chromium

            # Set up Python (pin to your supported version)
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.12.3"
                  cache: "pip"
                  cache-dependency-path: requirements.txt

            # Install your Python deps
            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            # Run your scraper
            - name: Run the dining-hall scraper and stash JSON
              run: |
                  python -m backend.main
                  mkdir -p /tmp
                  # Move the freshly generated JSON out of the main workspace and into /tmp
                  mv menu_summary.json /tmp/menu_summary.json
                  mv consolidated_menu.json /tmp/consolidated_menu.json

            # Switch to backend-deployment
            - name: Checkout backend-deployment
              uses: actions/checkout@v3
              with:
                  ref: backend-deployment
                  fetch-depth: 0
                  persist-credentials: true

            # Copy JSON from /tmp into backend-deployment root
            - name: Copy JSON into backend-deployment
              run: |
                  cp /tmp/menu_summary.json  ./menu_summary.json
                  cp /tmp/consolidated_menu.json ./consolidated_menu.json

            # Commit & push if changed
            - name: Commit & push updated JSON
              run: |
                  git add menu_summary.json consolidated_menu.json
                  if ! git diff --cached --quiet; then
                    git config user.name "github-actions[bot]"
                    git config user.email "github-actions[bot]@users.noreply.github.com"
                    git commit -m "ci: daily menu update $(date -u +'%Y-%m-%d')"
                    git push origin backend-deployment
                  else
                    echo "No changes to JSON on backend-deploymentâ€”skipping commit."
                  fi
